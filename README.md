# Probability of Sporulation potential in MAGs (SpoMAG) 


## Scope

<p align="center">
<img src="SpoMAGlogo.png" alt="SpoMAG_logo" width="600"/>
</p>

SpoMAG is an R-based machine learning tool designed to predict the sporulation potential of Metagenome-Assembled Genomes (MAGs) from uncultivated Firmicutes species that could have the potential to undergo sporulation, such as those from the Bacilli and Clostridia classes. The fundamental premise behind SpoMAG is that the complex combination of presence or absence of sporulation-associated genes could be leveraged to infer a genome's likelihood of undergoing sporulation, even in the absence of cultivation or complete genome assemblies.

What sets SpoMAG apart is its simplicity and accessibility. The only required input is a functional annotation matrix generated by tools such as eggNOG-mapper, containing the columns Preferred_name and KEGG_ko at a minimum. From this annotation file, SpoMAG automatically detects and extracts a curated list of sporulation-related genes and builds a binary presence/absence matrix, one row per genome, one column per gene. Users don’t need to perform any manual curation or preprocessing steps, they need to input the annotation file.

SpoMAG’s prediction pipeline is based on an ensemble learning strategy. It combines the predictive power of two robust base models: Random Forest (RF) and Support Vector Machine (SVM), both trained on high-quality labeled datasets of known spore-forming and non-spore-forming genomes. The probabilities predicted by these two models are then integrated into a meta-classifier, a technique known as model stacking. This allows SpoMAG to exploit complementary patterns in each model's output and improve prediction accuracy and robustness.

The final output of SpoMAG includes not only the predicted class (Sporulating or Non-sporulating) for each genome, but also the individual probabilities from the RF and SVM models, and the meta-model’s final probability score.

SpoMAG’s models were trained using stratified cross-validation and optimized to avoid overfitting and class imbalance. Performance was rigorously evaluated using AUC-ROC, F1-score, Accuracy, precision, specificity and recall. As a result, SpoMAG delivers high sensitivity and specificity across MAGs recovered from different hosts' microbiota.

Whether you're working with hundreds of MAGs from microbiome studies or a single novel genome from an uncultivated lineage, SpoMAG offers a user-friendly, scientifically robust tool to uncover sporulation potential, without the need for cultivation, phenotypic assays, or extensive manual annotation.


The repository for SpoMAG is at GitHub on the https://github.com/labinfo-lncc/SpoMAG. In this website you can report a bug and get help.



## Citation

Paper under publication.



## Installation of the SpoMAG package

You can install the **SpoMAG** package directly from GitHub using:

```r
# Install devtools if not already installed
install.packages("devtools")

# Install SpoMAG from GitHub
devtools::install_github("labinfo-lncc-br/SpoMAG")
```

### Dependencies

SpoMAG depends on the following packages:

- dplyr, version XXX
- tidyr, version XXX
- tibble, version XXX
- readr, version XXX
- caret, version XXX
- randomForest, version XXX


## Quick start
This is a quick example using the included files sporulation.csv (a known spore-former) and asporogenic.csv (a known non-spore-formers).

```r
# Load package
library(SpoMAG)

# Load example annotation tables
file_spor <- system.file("extdata", "sporulation.csv", package = "SpoMAG")
file_aspo <- system.file("extdata", "asporogenic.csv", package = "SpoMAG")

# Read files
df_spor <- readr::read_csv(file_spor)
df_aspo <- readr::read_csv(file_aspo)

# Step 1: Extract sporulation-related genes
genes_spor <- sporulation_gene_name(df_spor)
genes_aspo <- sporulation_gene_name(df_aspo)

# Step 2: Convert to binary matrix
bin_spor <- build_binary_matrix(genes_spor)
bin_aspo <- build_binary_matrix(genes_aspo)

# Step 3: Predict using ensemble model (preloaded in package)
model_path <- system.file("extdata", "modelos_stacking2.RData", package = "SpoMAG")

result_spor <- predict_sporulation(bin_spor, model_path)
result_aspo <- predict_sporulation(bin_aspo, model_path)

# View results
print(result_spor)
print(result_aspo)
```

The output includes the following columns:
- RF_Prob: probability from Random Forest
- SVM_Prob: probability from SVM
- Meta_Prediction: final ensemble prediction
- Meta_Prob_Esporulante: predicted probability of being a spore-former


### Input data format

To use SpoMAG, your input must be a functional annotation table, such as the output from eggNOG-mapper, containing at least two columns:

| Preferred_name | KEGG_ko |
|----------------|---------|
| ftsZ           | K02304  |
| spo0A          | K07699  |
| ...            | ...     |


- Preferred_name: the predicted name of the gene
- KEGG_ko: the KEGG Orthology code (e.g., K07699)

Each row should represent one gene annotation.

### Core functions in SpoMAG

### 1. `sporulation_gene_name()`
It extracts sporulation-related genes from an annotation dataframe by searching for gene names and KEGG orthologs.
Input: A dataframe with Preferred_name and KEGG_ko columns.
Output: A filtered dataframe containing only sporulation-related hits, each annotated with a standardized column consensus_name_this_study.

```r
genes <- sporulation_gene_name(df)
```

### 2. `build_binary_matrix()`
It creates a binary matrix indicating the presence (1) or absence (0) of known sporulation genes in each genome.
Input: A dataframe output from sporulation_gene_name().
Output: A wide-format dataframe (1 row per genome, 1 column per gene).

```r
matrix <- build_binary_matrix(genes)
```

Note: The function automatically fills in missing genes with 0 to ensure consistent input for prediction.

### 3. `predict_sporulation()`
It applies a pre-trained ensemble machine learning model (Random Forest + SVM) to predict the sporulation potential of genomes based on the binary matrix of genes.

Input:
    binary_matrix: Output from build_binary_matrix()
    model_path: Path to .RData file containing rf_model, svm_model, and meta_model.
Output: A dataframe with:
    RF_Prob: Probability from Random Forest
    SVM_Prob: Probability from SVM
    Meta_Prediction: Final prediction (Esporulante or Nao_Esporulante)
    Meta_Prob_Esporulante: Ensemble probability of being a spore-former

```r
results <- predict_sporulation(binary_matrix = matrix, model_path = "path/to/modelos_stacking2.RData")
```
